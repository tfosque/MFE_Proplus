"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.resolvePolicies = void 0;
const utils_1 = require("@strapi/utils");
const resolvePolicies = (route) => {
    const policiesConfig = route?.config?.policies ?? [];
    const resolvedPolicies = utils_1.policy.resolve(policiesConfig, route.info);
    const policiesMiddleware = async (ctx, next) => {
        const context = utils_1.policy.createPolicyContext('koa', ctx);
        for (const { handler, config } of resolvedPolicies) {
            const result = await handler(context, config, { strapi });
            if (![true, undefined].includes(result)) {
                throw new utils_1.errors.PolicyError();
            }
        }
        await next();
    };
    return [policiesMiddleware];
};
exports.resolvePolicies = resolvePolicies;
//# sourceMappingURL=policy.js.map